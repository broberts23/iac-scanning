name: Azure Bicep Template Analysis

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ /release/* ]

jobs:
  template-analysis:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Install Template Analyzer
      run: |
        wget https://github.com/Azure/template-analyzer/releases/download/v0.7.0/TemplateAnalyzer-linux-x64.zip
        unzip TemplateAnalyzer-linux-x64.zip -d targetfolder/
        chmod +x ./targetfolder/TemplateAnalyzer

    - name: Run Template Analyzer
      run: |
        ./targetfolder/TemplateAnalyzer analyze-directory ./templates --report-format sarif -o analysis-results.sarif
        cat analysis-results.sarif


    - name: Upload SARIF file to GitHub
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: analysis-results.sarif